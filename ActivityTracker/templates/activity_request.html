{% extends 'base.html' %}

{% block title %}
    Submit Reconciliations
{% endblock %}

{% block page_title %}
    <div data-page-title>{{ project_display }}</div>
{% endblock %}

{% block content %}
    <div class="card">
       <div class="card-header">
           Upload Files
       </div>

        <div class="card-body">
            <form id="uploadForm">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th style="text-align: right;">#</th> <!-- Row number column -->
                            <th>Bank Account</th>
                            <th>Year</th>
                            <th>Month</th>
                            <th>Selected File</th>
                            <th style="text-align: right;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="fileInputs">
                        <tr>
                            <td>
                                <div style="text-align: right;">1</div>
                            </td>
                            <td>
                                <select class="form-control" name="bank_account">
                                    <option value="">Select Bank Account</option>
                                    {% for account in bank_accounts %}
                                        <option value="{{ account.id }}">{{ account.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select class="form-control" name="year">
                                    <option value="">Select Year</option>
                                    {% for year in range(2020, 2031) %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select class="form-control" name="month">
                                    <option value="">Select Month</option>
                                    <option value="01">January</option>
                                    <option value="02">February</option>
                                    <option value="03">March</option>
                                    <option value="04">April</option>
                                    <option value="05">May</option>
                                    <option value="06">June</option>
                                    <option value="07">July</option>
                                    <option value="08">August</option>
                                    <option value="09">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </td>
                            <td>
                                <div class="file-input">
                                    <input style="display: block; width:100%; padding: auto 0;" id="file-upload" type="file" name="files">
                                </div>
                            </td>
                             <td>
                                <div class="file-input"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div></div>
                            </td>
                            <th></th>
                            <th></th>
                            <th></th>
                            <td></td>
                            <td>
                                <button class="btn-outline-custom" style="float: right;" type="button" onclick="addFileField()">Add File</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <table class="" style="width: 100%;">
                    <thead></thead>
                    <tbody>
                        <tr></tr>
                        <tr>
                            <td>
                                <div class="button-container">
                                    <button class="btn-outline-custom" type="button" onclick="showConfirmation('upload')">Upload File(s)</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </form>
        </div>
    </div>

    <div class="card">
       <div class="card-header">
           Uploaded Files
       </div>

        <div class="card-body">
            <table id="uploadedFilesTable" class="table table-striped table-bordered table-hover paginated">
                <thead>
                    <tr>
                        <th data-orderable="false" data-ordering="false"><input type="checkbox" id="selectAll"></th><!-- Select all checkbox -->
                        <th data-orderable="false" data-ordering="false">#</th> <!-- Row number column -->
                        <th>Bank Account</th>
                        <th>Year</th>
                        <th>Month</th>
                        <th style="max-width: 15%; word-break: break-all; white-space: normal;">File Name</th>
                        <th>Status</th>
                        <th style="display: none;">Batch_Id</th> <!-- Hidden column -->
                        <th style="text-align: right;">View Request</th>
                        <th>Download File</th>
                        <th>Change File</th>
                        <th style="text-align: right;">Delete Request</th>
                    </tr>
                </thead>
                <tbody id="uploadedFilesBody">
                    <tr>
                        <td><input type="checkbox" class="rowCheckbox"></td> <!-- Row checkbox -->
                        <td>1</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td style="max-width: 15%; word-break: break-all; white-space: normal;"></td>
                        <td style="text-align: center;">No files uploaded...</td>
                        <td style="display: none;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            <table class="" style="width: 100%; margin-top: 1rem;">
                <thead></thead>
                <tbody>
                    <tr>
                        <td style="text-align: center;">
                            <div class="button-container">
                                <button class="btn-outline-custom" type="button" onclick="showConfirmation('submit')">Submit Reconciliation(s)</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>

        function showConfirmation(actionType) {
            let modalTitle = "";
            let modalMessage = "";

            if (actionType === "upload") {
                modalTitle = "Confirm File Upload";
                modalMessage = "Are you sure you want to upload the selected file(s)?";
                $("#confirmAction").off("click").on("click", function () {
                    $("#confirmationModal").modal("hide");
                    uploadFiles();
                });
            } else if (actionType === "submit") {
                modalTitle = "Confirm Submission";
                modalMessage = "Are you sure you want to submit the uploaded reconciliation(s)?";
                $("#confirmAction").off("click").on("click", function () {
                    $("#confirmationModal").modal("hide");
                    submitFiles();
                });
            } else if (actionType === "delete file") {
                modalTitle = "Confirm File Deletion";
                modalMessage = "Are you sure you want to delete this file?";
                $("#confirmAction").off("click").on("click", function () {
                    $("#confirmationModal").modal("hide");
                    deleteFile(pendingDelete.filename, pendingDelete.button);
                });
            }
             else if (actionType === "edit uploaded file") {
                modalTitle = "Confirm File Upload";
                modalMessage = "Are you sure you want to change the uploaded file?";
                $("#confirmAction").off("click").on("click", function () {
                    $("#confirmationModal").modal("hide");
                    editSubmittedFile();
                });
            }

            $("#confirmationModalLabel").text(modalTitle);
            $("#confirmationMessage").text(modalMessage);

            $("#confirmationModal").modal({
                backdrop: true,
                keyboard: false
            });

            // Wait for Bootstrap to insert backdrop, then adjust z-index
            setTimeout(function () {
                $('.modal-backdrop').last().addClass('confirmation-backdrop');
            }, 10);
        }

        function addFileField() {
            const addButtonRow = $("#fileInputs tr:last"); // The "Add File" button is in the last row
            const newRowIndex = $("#fileInputs tr").length; // Adjust the index as needed

            let bankAccountsOptions = `
                <option value="">Select Bank Account</option>
                {% for account in bank_accounts %}
                    <option value="{{ account.id }}">{{ account.name }}</option>
                {% endfor %}
            `;

            const newRow = $(`
                <tr>
                    <td style="text-align: right;">${newRowIndex}</td>
                    <td>
                        <select class="form-control" name="bank_account">
                            ${bankAccountsOptions}
                        </select>
                    </td>
                    <td>
                        <select class="form-control" name="year">
                            <option value="">Select Year</option>
                            {% for year in range(2020, 2031) %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select class="form-control" name="month">
                            <option value="">Select Month</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </td>
                    <td>
                        <div class="file-input">
                            <input style="display: block; width:100%; padding: auto 0;" id="file-upload" type="file" name="files">
                        </div>
                    </td>
                    <td>
                        <button class="btn-outline-custom" style="float: right;" type="button" onclick="removeField(this)">Remove File</button>
                    </td>
                </tr>
            `);

            // Insert the new row before the "Add File" button row
            addButtonRow.before(newRow);
            updateRowNumbers("#fileInputs");
        }

        function removeField(button) {
            $(button).closest("tr").remove();
            updateRowNumbers("#fileInputs"); // Update row numbers after removal
        }

        function uploadFiles() {
            let formData = new FormData();
            let fileRows = $("#fileInputs tr");
            let uploadedIndices = [];  // To track successfully uploaded rows
            let duplicateIndices = []; // To track duplicate rows

            fileRows.each(function (index) {
                let bankAccount = $(this).find("select[name='bank_account']").val();
                let year = $(this).find("select[name='year']").val();
                let month = $(this).find("select[name='month']").val();
                let fileInput = $(this).find("input[type='file']")[0];

                if (fileInput && fileInput.files.length > 0) {
                    formData.append("files", fileInput.files[0]);
                    formData.append("bank_account", bankAccount);
                    formData.append("year", year);
                    formData.append("month", month);
                    uploadedIndices.push(index);
                }
            });

            $.ajax({
                url: "/upload",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    $("#fileInputs tr").css("background-color", ""); // Reset row colors

                    if (response.duplicates && response.duplicates.length > 0) {
                        duplicateIndices = response.duplicates;
                        duplicateIndices.forEach(function(index) {
                            $("#fileInputs tr").eq(index).css("background-color", "#ffcccc"); // Mark duplicates
                        });
                        showFlashMessage("Some files were not uploaded because their details already exist in the database.", "warning");
                    }

                    // Remove only successfully uploaded rows (excluding duplicates)
                    uploadedIndices = uploadedIndices.filter(index => !duplicateIndices.includes(index));
                    uploadedIndices.sort((a, b) => b - a); // Sort in descending order to avoid index shift issues
                    uploadedIndices.forEach(index => {
                        $("#fileInputs tr").eq(index).remove();
                    });

                    // Display updated uploaded files table
                    displayUploadedFiles(response.files);

                    if (!response.duplicates || response.duplicates.length === 0) {
                        showFlashMessage(response.message, "success");
                        // Reset the form to its initial state
                    $("#uploadForm")[0].reset();

                    // Remove all dynamically added file input fields except the first one
                    $("#fileInputs").html(`
                        <tr>
                            <td>
                                <div style="text-align: right;">1</div>
                            </td>
                            <td>
                                <select class="form-control" name="bank_account">
                                    <option value="">Select Bank Account</option>
                                    {% for account in bank_accounts %}
                                        <option value="{{ account.id }}">{{ account.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select class="form-control" name="year">
                                    <option value="">Select Year</option>
                                    {% for year in range(2020, 2031) %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select class="form-control" name="month">
                                    <option value="">Select Month</option>
                                    <option value="01">January</option>
                                    <option value="02">February</option>
                                    <option value="03">March</option>
                                    <option value="04">April</option>
                                    <option value="05">May</option>
                                    <option value="06">June</option>
                                    <option value="07">July</option>
                                    <option value="08">August</option>
                                    <option value="09">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </td>
                            <td>
                                <div class="file-input">
                                    <input style="display: block; width:100%; padding: auto 0;" id="file-upload" type="file" name="files">
                                </div>
                            </td>
                             <td>
                                <div class="file-input"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div></div>
                            </td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>
                                <button class="btn-outline-custom" style="float: right;" type="button" onclick="addFileField()">Add File</button>
                            </td>
                        </tr>
                    `);
                    }
                },
                error: function(error) {
                    showFlashMessage(error.responseJSON.error, "danger");
                }
            });
        }

        function displayUploadedFiles(files) {
            let uploadedFilesBody = $("#uploadedFilesBody");

            if ($.fn.DataTable.isDataTable("#uploadedFilesTable")) {
                $("#uploadedFilesTable").DataTable().destroy(); // Destroy instance before updating table content
            }

            uploadedFilesBody.empty(); // Clear existing rows

            if (files.length === 0) {
                uploadedFilesBody.append(`
                    <tr>
                        <td><input type="checkbox" class="rowCheckbox"></td> <!-- Row checkbox -->
                        <td>1</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td style="text-align: center;">No files uploaded...</td>
                        <td></td>
                        <td style="display: none;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                `);
            } else {
                files.forEach((file, index) => {
                    uploadedFilesBody.append(`
                        <tr>
                            <td>
                                <input type="checkbox" class="rowCheckbox">
                            </td>
                            <td>${index + 1}</td>
                            <td>${file.bank_account}</td>
                            <td>${file.year}</td>
                            <td>${file.month}</td>
                            <td style="max-width: 150px; white-space: normal; overflow-wrap: break-word; font-weight: normal;">${file.file_name}</td>
                            <td>${file.submission_status}</td>
                            <td style="display: none;">${file.batch_id}</td>

                            <td>
                                <button type="button" class="btn-outline-custom view-request-btn-submit float-right">View</button>
                            </td>
                            <td>
                                <button type="button" class="btn-outline-custom float-right" data-filename="${file.file_name}" onclick="downloadFile(this)">Download</button>
                            </td>
                            <td>
                                <button type="button" class="btn-outline-custom float-right edit-file-uploaded-btn" data-bank-account-name="${file.bank_account}" data-year="${file.year}" data-month="${file.month}" data-filename="${file.file_name}">Change</button>
                            </td>
                            <td>
                                <button type="button" class="btn-outline-custom float-right" data-filename="${file.file_name}" onclick="confirmDeleteFile(this)">Delete</button>
                            </td>
                        </tr>
                    `);
                });
            }

            // Now re-initialize the DataTable
            initializeRoleDataTable();
        }

        let pendingDelete = { filename: null, button: null };

        function confirmDeleteFile(button) {
            const filename = $(button).data("filename");
            pendingDelete.filename = filename;
            pendingDelete.button = button;

            showConfirmation("delete file");
        }

        function initializeRoleDataTable() {
            $('#uploadedFilesTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                lengthMenu: [5, 10, 25, 50, 100],
                pageLength: 10,
                destroy: true, // <-- Important to allow reinitialization
                dom: '<"row"<"col-md-6"l><"col-md-6"f>>' +
                     '<"row"<"col-md-12"B>>' +
                     '<"row"<"col-md-12"t>>' +
                     '<"row"<"col-md-6"i><"col-md-6"p>>',
                buttons: [
                    { extend: 'copy', text: 'Copy', className: 'btn btn-secondary' },
                    { extend: 'csv', text: 'Export to CSV', className: 'btn btn-secondary' },
                    { extend: 'excel', text: 'Export to Excel', className: 'btn btn-secondary' },
                    { extend: 'pdf', text: 'Export to PDF', className: 'btn btn-secondary' },
                    { extend: 'print', text: 'Print', className: 'btn btn-secondary' }
                ],
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });
        }

        // Calling the reconciliation_file_details_modal.html
        $(document).off("click", ".view-request-btn-submit").on("click", ".view-request-btn-submit", function() {
            let row = $(this).closest("tr");

            let bankAccount = row.find("td:nth-child(3)").text().trim();
            let year = row.find("td:nth-child(4)").text().trim();
            let month = row.find("td:nth-child(5)").text().trim();
            let lastModified = "";
            let approveAs = row.find("td:nth-child(7)").text().trim();
            let fileName = row.find("td:nth-child(6)").text().trim();

            // Populate the modal fields
            $("#viewBankAccount").text(bankAccount);
            $("#viewYear").text(year);
            $("#viewMonth").text(month);
            $("#viewLastModified").text(lastModified);
            $("#viewApproveAs").text(approveAs);
            $("#viewFileName").text(fileName);

            // Fetch workflow details
            loadReconciliationWorkflow(bankAccount, year, month, fileName);

            // Show the modal after data is populated
            $("#viewRequestModal").modal("show");
        });

        // Show modal and populate fields for editing uploaded file
        $(document).off("click", ".edit-file-uploaded-btn").on("click", ".edit-file-uploaded-btn", function () {
            const bankAccountName = $(this).data('bank-account-name');
            const year = $(this).data('year');
            const month = $(this).data('month');
            const fileName = $(this).data('filename');

            // Populate the form fields
            $("#bank_account_name").val(bankAccountName);
            $("#year").val(year);
            $("#month").val(month);
            $("#existing_file_name").val(fileName); // Just show as reference, not in the file input

            // Reset the file input (optional)
            $("#file-upload-edit").val("");

            // Show the modal
            $("#submitUploadedFileEditModal").modal("show");
        });

        function deleteFile(filename, button) {
            $.ajax({
                url: "/delete-file",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ filename: filename }),
                success: function(response) {
                    showFlashMessage(response.message, "success");
                    $(button).closest("tr").remove(); // Remove the file row from the table
                    $.getJSON("/get-uploaded-files", function(response) {
                        if (response.files) {
                            displayUploadedFiles(response.files);
                        }
                    });
                },
                error: function(error) {
                    showFlashMessage(error.responseJSON.error, "danger");
                }
            });
        }

        // Handle "Download File" button click using data-filename
        function downloadFile(button) {
            const filename = button.getAttribute('data-filename');

            if (!filename) {
                alert("Filename not provided.");
                return;
            }

            const link = document.createElement('a');
            link.href = `/download/${encodeURIComponent(filename)}`; // Adjust if your route is different
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateRowNumbers(tableId) {
            $(`${tableId} tr:gt(0)`).each(function(index) {
                let hasAddFileButton = $(this).find("button").filter(function() {
                    return $(this).text().trim() === "Add File";
                }).length > 0;
                if (!hasAddFileButton && index === 0) {
                    $(this).find("td:first").text(index + 2);
                }
                else if(!hasAddFileButton && index > 0){
                }else {
                    $(this).find("td:first").text(""); // Clear row number for the "Add File" row
                }
            });
        }

        function submitFiles() {
            let files = [];

            $("#uploadedFilesBody tr").each(function () {
                let checkbox = $(this).find(".rowCheckbox");

                // Process only checked rows
                if (checkbox.prop("checked")) {
                    let bankAccount = $(this).find("td:nth-child(3)").text().trim();
                    let year = $(this).find("td:nth-child(4)").text().trim();
                    let month = $(this).find("td:nth-child(5)").text().trim();
                    let fileName = $(this).find("td:nth-child(6)").text().trim();
                    let batch = $(this).find("td:nth-child(8)").text().trim();

                    if (fileName && bankAccount && year && month) {
                        files.push({
                            bank_account_id: bankAccount,
                            year: year,
                            month: month,
                            file_name: fileName,
                            batch_id: batch,
                        });
                    }
                }
            });

            if (files.length === 0) {
                errorMessage = "No files to submit.";
                messageType = "warning";
                showFlashMessage(errorMessage, messageType);
                return;
            }

            $.ajax({
                url: "/submit_files",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ files: files }),
                success: function (response) {
                    showFlashMessage(response.message, "success");
                    $("#flashMessageModal").on("hidden.bs.modal", function () {
                        $.getJSON("/get-uploaded-files", function(response) {
                            if (response.files) {
                                displayUploadedFiles(response.files);
                            }
                        });
                    });

                    $("#flashMessageModal").on("hidden.bs.modal", function() {
                    // Save expanded panels
                    let expandedPanels = [];
                    $(".panel-collapse.in, .panel-collapse.show").each(function() {
                        expandedPanels.push(this.id);
                    });
                    localStorage.setItem("expandedPanels", JSON.stringify(expandedPanels));
                    files = [];
                    // $(".content").load(location.href + " .content > *"); // Reload only the content div
                    location.reload();
                });
                },
                error: function (xhr) {
                    let errorMessage = xhr.responseJSON.error || "An unexpected error occurred.";
                    let messageType = xhr.responseJSON.type || "danger";
                    showFlashMessage(errorMessage, messageType);
                }
            });
        }

        function editSubmittedFile() {
            const fileInput = document.getElementById("file-upload-edit");
            const file = fileInput.files[0];

            const bankAccount = $("#bank_account_name").val();
            const year = $("#year").val();
            const month = $("#month").val();

            if (!file) {
                showFlashMessage("Please select a file to upload.", "warning");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);
            formData.append("bank_account", bankAccount);
            formData.append("year", year);
            formData.append("month", month);

            $.ajax({
                url: "/update-uploaded-file",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    showFlashMessage(response.message, "success");
                    $("#submitUploadedFileEditModal").modal("hide");

                    // Refresh table
                    $.getJSON("/get-uploaded-files", function(data) {
                        if (data.files) {
                            displayUploadedFiles(data.files);
                        }
                    });
                },
                error: function(xhr) {
                    let errorMessage = xhr.responseJSON?.error || "An error occurred while updating the file.";
                    showFlashMessage(errorMessage, "danger");
                }
            });
        }

        $(document).ready(function() {

            $.getJSON("/get-uploaded-files", function(response) {
                if (response.files) {
                    displayUploadedFiles(response.files);
                }
            });

            $('.rowCheckbox, #selectAll').prop('checked', false);

            // Restore sidebar expanded state
            const savedPanels = JSON.parse(localStorage.getItem("expandedPanels") || "[]");
            savedPanels.forEach(function(id) {
                const panel = $("#" + id);
                panel.addClass("in show"); // For Bootstrap 3 or 4
                panel.prev(".panel-heading").find(".menu-collapse-heading").attr("aria-expanded", "true");
            });

            // Handle "Select All" checkbox
            $(document).on('click', '#selectAll', function() {
                $('.rowCheckbox').prop('checked', this.checked);
            });

            // Uncheck "Select All" if any row checkbox is unchecked
            $(document).on('change', '.rowCheckbox', function() {
                if (!$(this).prop('checked')) {
                    $('#selectAll').prop('checked', false);
                } else if ($('.rowCheckbox:checked').length === $('.rowCheckbox').length) {
                    $('#selectAll').prop('checked', true);
                }
            });
        });

        function initializeUploadedFilesPage() {
            $.getJSON("/get-uploaded-files", function(response) {
                if (response.files) {
                    displayUploadedFiles(response.files);
                } else {
                    $("#uploadedFilesTable tbody").html(
                        `<tr><td colspan="9" class="text-center">No files uploaded yet.</td></tr>`
                    );
                }
            });

            $('.rowCheckbox, #selectAll').prop('checked', false);

            $('#selectAll').off('click').on('click', function () {
                $('.rowCheckbox').prop('checked', $(this).prop('checked'));
            });

            $(document).off('change', '.rowCheckbox').on('change', '.rowCheckbox', function () {
                if (!$(this).prop('checked')) {
                    $('#selectAll').prop('checked', false);
                } else if ($('.rowCheckbox:checked').length === $('.rowCheckbox').length) {
                    $('#selectAll').prop('checked', true);
                }
            });
        }
    </script>

    <style>
        #confirmationModal {
            z-index: 1060; /* Higher than default Bootstrap modal (1050) */
        }
        #roleModal {
            z-index: 1050;
        }

        /* Ensure backdrop covers roleModal when confirmationModal is active */
        .modal-backdrop.confirmation-backdrop {
            z-index: 1055; /* Between roleModal and confirmationModal */
        }
    </style>

{% endblock %}
